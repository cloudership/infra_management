#!/bin/bash

set -euo pipefail

PROJECTDIR="$(dirname "${BASH_SOURCE[0]}")/.."

ENV="${1}"
shift

TRUE_OR_FALSE_OPTION="${1:-true}"
shift

cd "${PROJECTDIR}/live/${ENV}"

if [[ "${TRUE_OR_FALSE_OPTION}" = "true" ]] ; then
  export TF_VAR_enable_expensive="true"
  ORDER="$(cat order.txt)"
else
  export TF_VAR_enable_expensive="false"
  ORDER="$(tac order.txt)"
fi

for mod in ${ORDER}; do
  terragrunt plan -out /tmp/plan.tfplan --terragrunt-working-dir "${mod}"
  sleep 30
  terragrunt apply -auto-approve /tmp/plan.tfplan --terragrunt-working-dir "${mod}"
done
