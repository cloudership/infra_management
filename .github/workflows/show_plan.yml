name: Show Plan
on:
  push:
    branches-ignore:
      - "master"
jobs:
  terraform_plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: "Configure git"
        run: |
          git config --global --add "url.https://x:${TOKEN}@github.com/".insteadOf "ssh://git@github.com:"
          git config --global --add "url.https://x:${TOKEN}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global --add "url.https://x:${TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global --add "url.https://x:${TOKEN}@github.com/".insteadOf "git@github.com/"
        env:
          TOKEN: "${{ secrets.REPO_ACCESS_TOKEN }}"
      - name: "Install terra* tools"
        run: "sudo ./bin/bootstrap/get-terraform && sudo ./bin/bootstrap/get-terragrunt"
      - name: "Run plan"
        run: "bin/plan prod base /tmp/prod-base.tfplan"
        env:
          AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          AWS_SESSION_TOKEN: "${{ secrets.AWS_SESSION_TOKEN }}"
